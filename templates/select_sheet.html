<!DOCTYPE html>
<html>
<head>
    <title>Select Google Sheet</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <script>
        // Lấy token từ biến Python
        var oauthToken = "{{ oauth_token }}";  // Sử dụng dấu ngoặc kép để đảm bảo token được truyền đúng cách

        function onApiLoad() {
            gapi.load('auth2', initAuth);
            gapi.load('picker', {'callback': onPickerApiLoad});
        }

        function initAuth() {
            gapi.auth2.init({
                client_id: '1079227357584-bkfvshu2igl3dsnqa0hb2t1bptvem00j.apps.googleusercontent.com',
                scope: ['https://www.googleapis.com/auth/drive.file']
            }).then(function(authInstance) {
                if (authInstance.isSignedIn.get()) {
                    oauthToken = authInstance.currentUser.get().getAuthResponse().access_token;
                    createPicker();
                } else {
                    authInstance.signIn().then(function() {
                        oauthToken = authInstance.currentUser.get().getAuthResponse().access_token;
                        createPicker();
                    }).catch(function(error) {
                        console.error('Error during authentication:', error);
                    });
                }
            }).catch(function(error) {
                console.error('Error during auth initialization:', error);
            });
        }

        function onPickerApiLoad() {
            // Đã tải Google Picker API
        }

        function createPicker() {
            if (!oauthToken) {
                console.error('OAuth token is null.');
                return;
            }

            var picker = new google.picker.PickerBuilder()
                .addView(google.picker.ViewId.SPREADSHEETS)
                .setOAuthToken(oauthToken)
                .setDeveloperKey('AIzaSyA2ADgP66DqhS1IS_vkakubzZak-ExqBPw')
                .setCallback(pickerCallback)
                .build();
            picker.setVisible(true);
        }

        function pickerCallback(data) {
            if (data[google.picker.Response.ACTION] == google.picker.Action.PICKED) {
                var doc = data[google.picker.Response.DOCUMENTS][0];
                var fileId = doc[google.picker.Document.ID];
                window.location.href = '/read_sheet/' + fileId;
            }
        }

        // Tải các API
        gapi.load('auth2', onApiLoad);
        gapi.load('picker', onApiLoad);
    </script>
</head>
<body>
    <h1>Select a Google Sheet</h1>
    <button onclick="createPicker()">Open Picker</button>
</body>
</html>
